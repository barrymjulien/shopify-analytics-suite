# Content Security Policy (CSP) Implementation

This document outlines the Content Security Policy implementation in the Shopify Analytics Suite application to improve security and prevent common web vulnerabilities.

## Overview

Content Security Policy (CSP) is a security feature that helps prevent cross-site scripting (XSS), clickjacking, and other code injection attacks. Our implementation ensures that:

1. The app can only be embedded within legitimate Shopify admin interfaces
2. Resources are loaded only from trusted sources
3. Enhanced protection against clickjacking attacks
4. Proper script execution in sandboxed iframes

## Implementation Details

### CSP Middleware

We've implemented a CSP middleware system in `app/middleware/csp.server.js` that:

- Automatically detects the current shop context
- Applies appropriate CSP headers with shop-specific frame-ancestors directives
- Includes fallback mechanisms for unknown shop contexts
- Provides a utility function for wrapping loaders to ensure CSP headers are applied consistently
- Implements enhanced script-src directives to allow proper script execution in sandboxed iframes

### Key Files and Components

1. **CSP Middleware** (`app/middleware/csp.server.js`):
   - Core implementation of CSP header management
   - Provides `addCSPHeaders()` and `withCSPHeaders()` utilities
   - Enhanced shop detection from various sources including base64-encoded host parameters

2. **Server Entry Point** (`app/entry.server.jsx`):
   - Applies CSP headers at the server response level
   - Ensures universal protection for all responses generated by the application
   - Implements comprehensive shop detection with multiple fallback mechanisms
   - Sets critical script-src directives to enable JavaScript execution in Shopify's sandboxed iframe

3. **Shopify Server Extensions** (`app/shopify.server.js`):
   - Enhanced `addDocumentResponseHeaders` function to include CSP headers
   - Integrates with Shopify's authentication flow

4. **Root Layout** (`app/root.jsx`):
   - Applies CSP headers at the application root level
   - Ensures all routes inherit basic security headers

5. **App Layout** (`app/routes/app.jsx`):
   - Uses native session data for shop-specific CSP headers
   - Works with Shopify's boundary system for header propagation

## CSP Header Details

The following security headers are applied:

- **Content-Security-Policy**: Controls which resources can be loaded and from where
  - `frame-ancestors`: Restricts which domains can embed our app (specific shop domain and admin.shopify.com)
  - `script-src`: Allows script execution from trusted sources including 'self', 'unsafe-inline', 'unsafe-eval', and cdn.shopify.com
  - `object-src`: Set to 'none' to prevent object/embed-based attacks

- **X-Frame-Options**: Legacy header for browsers that don't support CSP frame-ancestors
  - Set to `SAMEORIGIN` for broad compatibility (older browsers may support this differently)

- **X-Content-Type-Options**: Prevents MIME type sniffing
  - Set to `nosniff`

- **Referrer-Policy**: Controls how much referrer information is included with requests
  - Set to `strict-origin-when-cross-origin`

## Addressing Iframe Sandbox Issues

Shopify embeds apps in sandboxed iframes, which can cause script execution issues without proper CSP configuration. Our implementation addresses this by:

1. Adding explicit `script-src` directives that allow 'unsafe-inline' and 'unsafe-eval' for Shopify's admin functionality
2. Setting headers early in the request lifecycle, before Shopify's default headers are applied
3. Providing multiple fallback mechanisms to detect the shop domain for proper CSP configuration
4. Using modern `X-Frame-Options: SAMEORIGIN` instead of the deprecated `ALLOW-FROM` syntax

These enhancements prevent "Blocked script execution" errors in sandboxed iframes and ensure the app loads properly within the Shopify admin interface.

## Usage in Routes

For route handlers that need custom CSP implementation:

```javascript
import { withCSPHeaders } from "../middleware/csp.server";

// Wrap your loader with the CSP utility
export const loader = withCSPHeaders(async ({ request }) => {
  // Your loader logic here
  return json(data);
});
```

## Debugging CSP Issues

If you encounter issues with CSP headers or iframe loading:

1. Check the browser console for CSP violation errors
2. Visit the debug route at `/app/debug-csp` to see detailed header information
3. Ensure the CSP headers include proper script-src directives
4. Verify that frame-ancestors includes the correct shop domain

## Security Considerations

- The CSP implementation is critical for Shopify embedded apps to function properly
- These headers help protect against clickjacking, XSS, and other common web vulnerabilities
- Changes to this implementation should be carefully tested in both development and production environments
- The script-src directives with 'unsafe-inline' and 'unsafe-eval' are necessary for proper functioning in Shopify's admin, but represent a security tradeoff
